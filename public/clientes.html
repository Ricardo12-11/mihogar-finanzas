<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="icon" type="image/png" href="icon.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestión de Clientes - MiHogarFinanzas</title>
  <link rel="stylesheet" href="assets.css">
  <style>
    .form-container, .table-container {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgb(0 0 0 / 0.1);
      margin-bottom: 1.25rem;
      border: 1px solid #e5e7eb;
    }
    .form-container h2 {
      color: #1e293b;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem;
    }
    .form-group { margin-bottom: 0; }
    .form-group label { margin-top: 0; }
    .actions button {
      margin-right: 0.35rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
    }
    .edit { background: #f59e0b; }
    .edit:hover { background: #d97706; }
    .delete { background: #ef4444; }
    .delete:hover { background: #dc2626; }
    #msg {
      margin-top: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
    }
    #msg:not(:empty) {
      background: #dcfce7;
      color: #166534;
      border-left: 3px solid #22c55e;
    }
    #msg.error:not(:empty) {
      background: #fee2e2;
      color: #dc2626;
      border-left: 3px solid #ef4444;
    }
    .bono-aplica { color: #16a34a; font-size: 0.75rem; }
    .bono-no-aplica { color: #dc2626; font-size: 0.75rem; }
  </style>
</head>
<body>

  <div class="sidebar">
    <div class="brand">
      <span>MiHogarFinanzas</span>
    </div>
    <a href="/clientes.html" class="active">Clientes</a>
    <a href="/inmuebles.html">Unidades</a>
    <a href="/planpagos.html">Plan de Pagos</a>
    <div class="logout">
      <button id="logout">Cerrar Sesión</button>
    </div>
  </div>

  <div class="main">
    <h1>Gestión de Clientes</h1>
    <p style="color: #64748b; margin-bottom: 1.25rem;">Administra la información de tus clientes</p>

    <div class="form-container">
      <h2 id="formTitle">Registrar Cliente</h2>
      <form id="clienteForm">
        <input type="hidden" id="clienteId">
        <div class="form-grid">
          <div class="form-group">
            <label for="nombre">Nombre Completo</label>
            <input type="text" id="nombre" placeholder="Ej: Juan Pérez García" required>
          </div>
          <div class="form-group">
            <label for="dni">DNI</label>
            <input type="text" id="dni" maxlength="8" placeholder="8 dígitos" required>
          </div>
          <div class="form-group">
            <label for="correo">Correo Electrónico</label>
            <input type="email" id="correo" placeholder="correo@ejemplo.com" required>
          </div>
          <div class="form-group">
            <label for="telefono">Teléfono</label>
            <input type="tel" id="telefono" placeholder="9xxxxxxxx" required>
          </div>
          <div class="form-group">
            <label for="ingresos">Ingresos Mensuales (S/)</label>
            <input type="number" id="ingresos" min="0" placeholder="Ej: 3000" required>
          </div>
          <div class="form-group">
            <label for="estado">Estado Civil</label>
            <select id="estado" required>
              <option value="">Seleccione...</option>
              <option value="Soltero">Soltero</option>
              <option value="Casado">Casado</option>
              <option value="Divorciado">Divorciado</option>
              <option value="Viudo">Viudo</option>
            </select>
          </div>
          <div class="form-group">
            <label for="primeraVivienda">¿Es su primera vivienda?</label>
            <select id="primeraVivienda" required>
              <option value="true">Sí, no tengo otra vivienda</option>
              <option value="false">No, ya tengo otra vivienda</option>
            </select>
          </div>
          <div class="form-group">
            <label for="tieneTerreno">¿Tiene terreno propio?</label>
            <select id="tieneTerreno" required>
              <option value="false">No</option>
              <option value="true">Sí, tengo terreno propio</option>
            </select>
          </div>
        </div>
        <button type="submit">Guardar Cliente</button>
        <div id="msg"></div>
      </form>
    </div>

    <div class="table-container">
      <h2>Lista de Clientes</h2>
      <div class="table-responsive">
        <table id="clientesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>DNI</th>
              <th>Correo</th>
              <th>Teléfono</th>
              <th>Ingresos</th>
              <th>Estado Civil</th>
              <th>Bono TP</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const api = '/api';
    const token = localStorage.getItem('mhf_token');
    if (!token) { alert('Inicia sesión para continuar'); window.location.href = '/login.html'; }

    document.getElementById('logout').onclick = () => {
      localStorage.removeItem('mhf_token');
      localStorage.removeItem('mhf_user');
      window.location.href = '/login.html';
    };

    const form = document.getElementById('clienteForm');
    const tbody = document.querySelector('#clientesTable tbody');
    const msg = document.getElementById('msg');
    const formTitle = document.getElementById('formTitle');
    let editMode = false;

    async function loadClientes() {
      const res = await fetch(api + '/clients', { headers: { Authorization: 'Bearer ' + token } });
      const clientes = await res.json();
      tbody.innerHTML = '';
      clientes.forEach(c => {
        const bonoEval = evaluarBonoTechoPropio(c);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${c.id}</td>
          <td>${c.full_name}</td>
          <td>${c.dni}</td>
          <td>${c.email}</td>
          <td>${c.phone}</td>
          <td>S/ ${c.income}</td>
          <td>${c.marital_status}</td>
          <td style="font-size:0.75rem;">${bonoEval.html}</td>
          <td class="actions">
            <button class="edit" onclick="editarCliente(${c.id}, '${c.full_name}', '${c.dni}', '${c.email}', '${c.phone}', '${c.income}', '${c.marital_status}', ${c.es_primera_vivienda}, ${c.tiene_terreno_propio})">Editar</button>
            <button class="delete" onclick="eliminarCliente(${c.id})">Eliminar</button>
          </td>`;
        tbody.appendChild(row);
      });
    }

    function evaluarBonoTechoPropio(cliente) {
      const ingresos = parseFloat(cliente.income) || 0;
      const esPrimeraVivienda = cliente.es_primera_vivienda !== false;
      const tieneTerreno = cliente.tiene_terreno_propio === true;
      const LIMITE_COMPRA = 3715;
      const LIMITE_CONSTRUIR = 2706;
      let resultado = { aplica: false, modalidades: [], html: '' };
      
      if (!esPrimeraVivienda) {
        resultado.html = '<span class="bono-no-aplica">No aplica<br><small>(Ya tiene vivienda)</small></span>';
        return resultado;
      }
      
      if (ingresos <= LIMITE_COMPRA) {
        resultado.aplica = true;
        resultado.modalidades.push({ tipo: 'Compra de Vivienda' });
      }
      
      if (ingresos <= LIMITE_CONSTRUIR && tieneTerreno) {
        resultado.aplica = true;
        resultado.modalidades.push({ tipo: 'Construcción en Sitio Propio' });
        resultado.modalidades.push({ tipo: 'Mejoramiento de Vivienda' });
      }
      
      if (resultado.aplica) {
        const modalidadesText = resultado.modalidades.map(m => m.tipo).join(', ');
        resultado.html = `<span class="bono-aplica">Aplica<br><small>${modalidadesText}</small></span>`;
      } else {
        resultado.html = '<span class="bono-no-aplica">No aplica<br><small>(Ingresos exceden límite)</small></span>';
      }
      return resultado;
    }

    loadClientes();

    function validarNombre(nombre) {
      if (!nombre || nombre.trim().length < 3) return 'El nombre debe tener al menos 3 caracteres';
      if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(nombre)) return 'El nombre solo puede contener letras y espacios';
      return null;
    }
    function validarDNI(dni) {
      if (!dni) return 'El DNI es obligatorio';
      if (!/^\d{8}$/.test(dni)) return 'El DNI debe tener exactamente 8 dígitos numéricos';
      return null;
    }
    function validarEmail(email) {
      if (!email) return 'El correo es obligatorio';
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) return 'El formato del correo no es válido';
      return null;
    }
    function validarTelefono(telefono) {
      if (!telefono) return 'El teléfono es obligatorio';
      if (!/^9\d{8}$/.test(telefono)) return 'El teléfono debe tener 9 dígitos y empezar con 9';
      return null;
    }
    function validarIngresos(ingresos) {
      if (!ingresos || parseFloat(ingresos) <= 0) return 'Los ingresos deben ser mayores a 0';
      if (parseFloat(ingresos) > 1000000) return 'Los ingresos no pueden superar S/ 1,000,000';
      return null;
    }
    function validarEstadoCivil(estado) {
      if (!estado) return 'Debe seleccionar un estado civil';
      return null;
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const dni = document.getElementById('dni').value;
      const correo = document.getElementById('correo').value;
      const telefono = document.getElementById('telefono').value;
      const ingresos = document.getElementById('ingresos').value;
      const estado = document.getElementById('estado').value;

      let error = validarNombre(nombre) || validarDNI(dni) || validarEmail(correo) || 
                  validarTelefono(telefono) || validarIngresos(ingresos) || validarEstadoCivil(estado);
      
      if (error) {
        msg.innerText = error;
        msg.className = 'error';
        return;
      }

      const data = {
        full_name: nombre.trim(),
        dni: dni,
        email: correo.trim(),
        phone: telefono,
        income: ingresos,
        marital_status: estado,
        es_primera_vivienda: document.getElementById('primeraVivienda').value === 'true',
        tiene_terreno_propio: document.getElementById('tieneTerreno').value === 'true'
      };

      let res;
      if (editMode) {
        const id = document.getElementById('clienteId').value;
        res = await fetch(api + '/clients/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify(data)
        });
        formTitle.textContent = "Registrar Cliente";
        editMode = false;
      } else {
        res = await fetch(api + '/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
          body: JSON.stringify(data)
        });
      }

      if (!res.ok) { msg.innerText = 'Error al guardar cliente'; msg.className = 'error'; return; }
      msg.innerText = 'Cliente guardado correctamente'; msg.className = '';
      form.reset();
      loadClientes();
    };

    window.eliminarCliente = async (id) => {
      if (!confirm('¿Eliminar este cliente?')) return;
      await fetch(api + '/clients/' + id, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } });
      loadClientes();
    };

    window.editarCliente = (id, nombre, dni, correo, telefono, ingresos, estado, primeraVivienda, tieneTerreno) => {
      document.getElementById('clienteId').value = id;
      document.getElementById('nombre').value = nombre;
      document.getElementById('dni').value = dni;
      document.getElementById('correo').value = correo;
      document.getElementById('telefono').value = telefono;
      document.getElementById('ingresos').value = ingresos;
      document.getElementById('estado').value = estado;
      document.getElementById('primeraVivienda').value = primeraVivienda ? 'true' : 'false';
      document.getElementById('tieneTerreno').value = tieneTerreno ? 'true' : 'false';
      formTitle.textContent = "Editar Cliente";
      editMode = true;
    };
  </script>
</body>
</html>
