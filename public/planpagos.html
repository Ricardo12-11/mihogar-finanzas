<!doctype html>
<html lang="es">
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width,initial-scale=1'>
  <title>Plan de Pagos - MiHogarFinanzas</title>
  <link rel="icon" type="image/png" href="icon.png">
  <link rel="stylesheet" href="estilos.css">
  <style>
    /* --- ESTILOS PROFESIONALES (UI KIT) --- */
    :root {
      --primary-color: #0f766e; /* Verde corporativo */
      --primary-light: #f0fdfa;
      --border-color: #cbd5e1;
      --text-gray: #64748b;
    }

    body { background-color: #f8fafc; font-family: 'Segoe UI', system-ui, sans-serif; }

    .content-box {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      margin-bottom: 2rem;
      border: 1px solid #e2e8f0;
    }

    .section-title {
      grid-column: 1 / -1;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 0.5rem;
    }
    
    form { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
      gap: 1.25rem; 
      align-items: end;
    }

    form label { 
      display: block; 
      margin-bottom: 0.4rem; 
      font-size: 0.85rem; 
      color: #334155; 
      font-weight: 600; 
    }
    
    form input, form select { 
      width: 100%; 
      padding: 0.75rem; 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    form input:focus, form select:focus { 
      outline: none; 
      border-color: var(--primary-color); 
      box-shadow: 0 0 0 3px var(--primary-light); 
    }
    
    .input-group { position: relative; }
    .input-group span { 
      position: absolute; left: 12px; top: 11px; 
      color: var(--text-gray); font-size: 0.9rem; 
    }
    .input-group input { padding-left: 35px; }

    .input-row { display: flex; gap: 10px; }
    .input-row input { flex: 1; }
    .input-row select { width: 110px; }

    .result-box {
      grid-column: 1 / -1;
      background: var(--primary-light);
      border: 1px solid #99f6e4;
      border-radius: 8px;
      padding: 1rem;
    }
    .result-box label { color: var(--primary-color); margin-bottom: 0; }
    .result-box input { 
      background: transparent; border: none; 
      font-size: 1.5rem; font-weight: 800; 
      color: var(--primary-color); padding: 0.25rem 0;
    }

    .btn-action {
      grid-column: 1 / -1; margin-top: 2rem;
      background: var(--primary-color); color: white;
      border: none; padding: 1rem; border-radius: 8px;
      font-weight: 600; font-size: 1rem; cursor: pointer;
      transition: background 0.3s;
    }
    .btn-action:hover { background: #115e59; }

    .table-container { overflow-x: auto; border-radius: 8px; border: 1px solid #e2e8f0; }
    table { width: 100%; border-collapse: collapse; min-width: 900px; }
    th { 
      background: #f1f5f9; color: #475569; padding: 1rem; 
      text-align: right; font-size: 0.75rem; text-transform: uppercase; 
    }
    th:first-child { text-align: center; } 
    
    td { 
      padding: 0.75rem 1rem; border-bottom: 1px solid #e2e8f0; 
      font-size: 0.85rem; color: #334155; text-align: right; 
    }
    td:first-child { text-align: center; } 
    
    .kpi-container {
      display: flex; gap: 2rem; flex-wrap: wrap;
      background: white; border: 1px solid #e2e8f0;
      padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;
    }
    .kpi-item { display: flex; flex-direction: column; }
    .kpi-label { font-size: 0.75rem; color: var(--text-gray); text-transform: uppercase; font-weight: 700; }
    .kpi-value { font-size: 1.1rem; font-weight: 700; color: #1e293b; }

  </style>
</head>
<body>

<div class="sidebar">
  <div class="brand">
    <span>MiHogarFinanzas</span>
  </div>
  <a href="/inmuebles.html">Inmuebles</a>
  <a href="/usuarios.html">Usuarios</a>
  <a href="/planpagos.html" class="active">Plan de Pagos</a>
  <a href="/creditos.html">Créditos</a>
  <div class="logout">
    <button id="logout">Cerrar Sesión</button>
  </div>
</div>

<div class="main">
  <h1>Generación del Plan de Pagos</h1>
  <p style="color: var(--text-gray); margin-bottom: 2rem;">Simulación bajo Método Francés (Cuota Constante).</p>

  <div class="content-box">
    <form id="pagoForm">
      
      <!-- 1. DATOS BÁSICOS -->
      <div class="section-title" style="margin-top: 0;">1. Cliente y Propiedad</div>
      <div style="grid-column: 1/-1; display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
          <div>
            <label>Cliente</label>
            <select id="clientSelect" required><option value="">Cargando...</option></select>
          </div>
          <div>
            <label>Propiedad</label>
            <select id="propertySelect" required><option value="">Cargando...</option></select>
          </div>
      </div>

      <!-- 2. ESTRUCTURA -->
      <div class="section-title">2. Estructura del Financiamiento</div>
      
      <div>
        <label>Precio del Inmueble</label>
        <div class="input-group">
          <span class="currency-symbol">S/</span>
          <input type="number" id="precioInmueble" step="0.01" min="0" placeholder="0.00">
        </div>
      </div>

      <div>
        <label>Cuota Inicial (%)</label>
        <input type="number" id="pctCuotaInicial" step="0.01" min="0" max="99" placeholder="Ej: 10">
      </div>

      <div>
        <label>Cuota Inicial (Monto)</label>
        <div class="input-group">
          <span class="currency-symbol">S/</span>
          <input type="number" id="montoCuotaInicial" step="0.01" min="0" placeholder="0.00">
        </div>
      </div>

      <div>
        <label>Bono (Techo Propio/Mivivienda)</label>
        <div class="input-group">
          <span class="currency-symbol">S/</span>
          <input type="number" id="bonoMonto" step="0.01" min="0" placeholder="Ej: 43000">
        </div>
      </div>

      <div class="result-box">
        <label>Monto a Financiar (Incluye Gastos Capitalizados)</label>
        <input type="number" id="monto" readonly value="0.00">
      </div>

      <!-- 3. CONDICIONES -->
      <div class="section-title">3. Condiciones del Crédito</div>

      <div>
        <label>Moneda</label>
        <select id="moneda">
          <option value="PEN">Soles (PEN)</option>
          <option value="USD">Dólares (USD)</option>
        </select>
      </div>

      <div>
        <label>Plazo (N° Cuotas)</label>
        <input type="number" id="plazo" required placeholder="Ej: 48">
      </div>

      <div>
        <label>Frecuencia de Pago</label>
        <select id="frecuenciaPago">
          <option value="30">Mensual (30 días)</option>
          <option value="90">Trimestral (90 días)</option>
        </select>
      </div>

      <div>
        <label>Tasa Interés (%)</label>
        <div class="input-row">
          <input type="number" id="tasa" step="0.01" required placeholder="Ej: 8.75">
          <select id="tipoTasa">
            <option value="efectiva">Efectiva</option>
            <option value="nominal">Nominal</option>
          </select>
        </div>
      </div>

      <div>
        <label>Capitalización (Solo Nominal)</label>
        <select id="capitalizacion">
          <option value="mensual">Mensual</option>
          <option value="diaria">Diaria</option>
        </select>
      </div>

      <div>
        <label>Fecha Desembolso</label>
        <input type="date" id="fecha" required>
      </div>

      <div>
        <label>Tipo de Gracia</label>
        <select id="periodoGracia">
          <option value="ninguno">Ninguno</option>
          <option value="total">Total</option>
          <option value="parcial">Parcial</option>
        </select>
      </div>

      <div>
        <label>Meses de Gracia</label>
        <input type="number" id="mesesGracia" min="0" max="24" placeholder="0">
      </div>

      <!-- 4. SEGUROS Y GASTOS -->
      <div class="section-title">4. Seguros y Gastos Iniciales</div>

      <div>
        <label>Seguro Desgravamen (%)</label>
        <div class="input-row">
          <input type="number" id="seguroDesgravamen" step="0.0001" placeholder="Ej: 0.55">
          <select id="periodoDesgravamen">
            <option value="mensual">Mensual</option>
            <option value="anual">Anual</option>
          </select>
        </div>
      </div>

      <div>
        <label>Seguro Todo Riesgo (%)</label>
        <div class="input-row">
          <input type="number" id="seguroRiesgo" step="0.0001" placeholder="Ej: 0.25">
          <select id="periodoRiesgo">
            <option value="anual">Anual</option>
            <option value="mensual">Mensual</option>
          </select>
        </div>
      </div>

      <div>
        <label>Gastos Notariales (Se suman al Préstamo)</label>
        <input type="number" id="costesNotariales" placeholder="0.00">
      </div>

      <div>
        <label>Gastos Registrales (Se suman al Préstamo)</label>
        <input type="number" id="costesRegistrales" placeholder="0.00">
      </div>

      <div>
        <label>Tasación (Se suma al Préstamo)</label>
        <input type="number" id="tasacion" placeholder="0.00">
      </div>

      <div>
        <label>Tasa Descuento (COK %)</label>
        <input type="number" id="tasaDescuento" step="0.01" placeholder="Ej: 15">
      </div>

      <button type="submit" class="btn-action">Calcular Cuota y Guardar Plan</button>
      
      <div class="full-width">
        <p id="msg" class="error" style="display:none;"></p>
        <p id="ok" class="success" style="display:none;"></p>
      </div>
    </form>
  </div>

  <div class="content-box" id="resultadosSection" style="display:none;">
    <h2>Cronograma de Pagos</h2>
    
    <div class="kpi-container" id="indicadoresContent"></div>
    
    <div class="table-container">
      <table id="tablaPagos">
        <thead>
        <tr>
          <th style="text-align:center;">N°</th>
          <th>Saldo Capital</th>
          <th>Amortización</th>
          <th>Interés</th>
          <th>Seg. Desgr.</th>
          <th>Seg. Riesgo</th>
          <th>Cuota Total</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const api='/api';
const token = localStorage.getItem('mhf_token');
if(!token){ window.location.href='/login.html'; }

document.getElementById('logout').onclick = ()=>{
  localStorage.removeItem('mhf_token');
  localStorage.removeItem('mhf_user');
  window.location.href='/login.html';
};

document.getElementById('fecha').valueAsDate = new Date();

const pagoForm = document.getElementById("pagoForm");
const tabla = document.querySelector("#tablaPagos tbody");
const msg = document.getElementById("msg");
const ok = document.getElementById("ok");

let clientesData = [];
let propiedadesData = [];

// --- RECALCULO AUTOMÁTICO ---
function recalcularMonto() {
    const precio = parseFloat(document.getElementById('precioInmueble').value) || 0;
    const inicial = parseFloat(document.getElementById('montoCuotaInicial').value) || 0;
    const bono = parseFloat(document.getElementById('bonoMonto').value) || 0;
    
    const gNotarial = parseFloat(document.getElementById('costesNotariales').value) || 0;
    const gRegistral = parseFloat(document.getElementById('costesRegistrales').value) || 0;
    const gTasacion = parseFloat(document.getElementById('tasacion').value) || 0;
    
    let base = Math.max(0, precio - inicial - bono);
    const final = base + gNotarial + gRegistral + gTasacion;
    
    document.getElementById('monto').value = final.toFixed(2);
}

['precioInmueble', 'montoCuotaInicial', 'bonoMonto', 
 'costesNotariales', 'costesRegistrales', 'tasacion'].forEach(id => {
    document.getElementById(id).addEventListener('input', recalcularMonto);
});

document.getElementById('pctCuotaInicial').addEventListener('input', function() {
    const precio = parseFloat(document.getElementById('precioInmueble').value) || 0;
    const pct = parseFloat(this.value) || 0;
    const monto = precio * (pct / 100);
    document.getElementById('montoCuotaInicial').value = monto.toFixed(2);
    recalcularMonto();
});

document.getElementById('moneda').addEventListener('change', function() {
    const s = this.value === 'PEN' ? 'S/' : '$';
    document.querySelectorAll('.currency-symbol').forEach(el => el.innerText = s);
});

async function loadData(){
  try{
    const [clRes, prRes] = await Promise.all([
        fetch(api+'/clients', {headers:{Authorization:'Bearer '+token}}),
        fetch(api+'/properties', {headers:{Authorization:'Bearer '+token}})
    ]);
    clientesData = await clRes.json();
    propiedadesData = await prRes.json();

    const clSel = document.getElementById('clientSelect');
    clSel.innerHTML = '<option value="">-- Seleccionar --</option>' + 
        clientesData.map(c=>`<option value="${c.id}">${c.full_name}</option>`).join('');

    const prSel = document.getElementById('propertySelect');
    prSel.innerHTML = '<option value="">-- Seleccionar --</option>' + 
        propiedadesData.map(p=>`<option value="${p.id}">${p.project_name} - ${p.currency} ${p.price}</option>`).join('');
    
    prSel.addEventListener('change', function() {
        const p = propiedadesData.find(x => x.id == this.value);
        if(p) {
            document.getElementById('precioInmueble').value = p.price;
            document.getElementById('moneda').value = p.currency || 'PEN';
            document.getElementById('moneda').dispatchEvent(new Event('change'));
            recalcularMonto();
        }
    });
  } catch(e) { console.error(e); }
}
loadData();

// --- FUNCIONES FINANCIERAS ---

function nominalToEffective(nominalRate, capitalizacion) {
  const periodos = { 'mensual': 12, 'diaria': 360, 'anual': 1 };
  const n = periodos[capitalizacion] || 12;
  return Math.pow(1 + nominalRate/100/n, n) - 1;
}

function periodRateFromAnnual(annualRate, diasPeriodo) {
    return Math.pow(1 + annualRate, diasPeriodo / 360) - 1;
}

function calcularVAN(montoInicial, flujos, tasaDescuentoAnual) {
  const tasaMensual = Math.pow(1 + tasaDescuentoAnual, 1/12) - 1;
  let vna = 0;
  for (let i = 0; i < flujos.length; i++) {
    vna += flujos[i] / Math.pow(1 + tasaMensual, i + 1);
  }
  return { van: montoInicial - vna }; 
}

function calcularTIR(montoInicial, flujos) {
  if (!montoInicial || !flujos.length) return 0;
  function npv(rate) {
    let sum = -montoInicial;
    for (let i = 0; i < flujos.length; i++) sum += flujos[i] / Math.pow(1 + rate, i + 1);
    return sum;
  }
  let low = -0.5, high = 2, mid;
  for (let i = 0; i < 100; i++) {
    mid = (low + high) / 2;
    if (npv(mid) > 0) low = mid; else high = mid;
  }
  return mid;
}

pagoForm.onsubmit = async function(e){
  e.preventDefault();
  msg.style.display='none'; ok.style.display='none';

  // DATOS
  const precio = parseFloat(document.getElementById('precioInmueble').value) || 0;
  const monto = parseFloat(document.getElementById('monto').value) || 0; 
  const plazo = parseInt(document.getElementById('plazo').value);
  const tasaInput = parseFloat(document.getElementById('tasa').value);
  const tipoTasa = document.getElementById('tipoTasa').value;
  const frecuenciaDias = parseInt(document.getElementById('frecuenciaPago').value);
  const moneda = document.getElementById('moneda').value;
  const simbolo = moneda === 'PEN' ? 'S/' : '$';
  
  // SEGUROS
  let tasaDesg = parseFloat(document.getElementById('seguroDesgravamen').value) || 0;
  if(document.getElementById('periodoDesgravamen').value === 'anual') tasaDesg /= 12;
  const factorDesg = tasaDesg / 100;
  
  let tasaRiesgo = parseFloat(document.getElementById('seguroRiesgo').value) || 0;
  if(document.getElementById('periodoRiesgo').value === 'anual') tasaRiesgo /= 12;
  const factorRiesgo = tasaRiesgo / 100;

  // TASAS
  let tea = (tipoTasa === 'nominal') 
    ? nominalToEffective(tasaInput, document.getElementById('capitalizacion').value)
    : tasaInput / 100;
  const tem = periodRateFromAnnual(tea, frecuenciaDias);

  // --- MÉTODO FRANCÉS (CUOTA TOTAL CONSTANTE) ---
  const tasaTotalCalculo = tem + factorDesg;
  let cuotaFija = 0;
  
  if(tasaTotalCalculo > 0) {
      cuotaFija = monto * (tasaTotalCalculo * Math.pow(1 + tasaTotalCalculo, plazo)) / (Math.pow(1 + tasaTotalCalculo, plazo) - 1);
  } else {
      cuotaFija = monto / plazo;
  }

  // GENERAR CRONOGRAMA
  let saldo = monto;
  let cronogramaFinal = [];
  let totalSegDesg = 0, totalSegRiesgo = 0; // Totales separados
  let totalInteres = 0, totalAmort = 0, totalPagar = 0;
  let flujosCaja = [];

  for (let i = 1; i <= plazo; i++) {
      const interes = saldo * tem;
      const segDesg = saldo * factorDesg;
      const segRiesgo = precio * factorRiesgo; 
      
      let cuotaTotalMes = cuotaFija + segRiesgo; 
      
      let amortizacion = cuotaFija - interes - segDesg;
      
      if (i === plazo) {
          amortizacion = saldo;
          cuotaTotalMes = amortizacion + interes + segDesg + segRiesgo;
      }
      
      const saldoInicial = saldo;
      saldo -= amortizacion;
      if(saldo < 0) saldo = 0;

      totalInteres += interes;
      totalAmort += amortizacion;
      totalSegDesg += segDesg;
      totalSegRiesgo += segRiesgo;
      totalPagar += cuotaTotalMes;
      flujosCaja.push(cuotaTotalMes);

      cronogramaFinal.push({
          installment_number: i,
          balance_start: saldoInicial,
          amortization: amortizacion,
          interest: interes,
          seg_desg: segDesg,
          seg_riesgo: segRiesgo,
          totalFinal: cuotaTotalMes,
          balance: saldo
      });
  }

  // RENDER
  document.getElementById('resultadosSection').style.display = 'block';
  tabla.innerHTML = '';
  
  cronogramaFinal.forEach(c => {
      tabla.innerHTML += `
        <tr>
            <td style="text-align:center;">${c.installment_number}</td>
            <td>${simbolo} ${c.balance_start.toFixed(2)}</td>
            <td>${simbolo} ${c.amortization.toFixed(2)}</td>
            <td>${simbolo} ${c.interest.toFixed(2)}</td>
            <td>${simbolo} ${c.seg_desg.toFixed(2)}</td>
            <td>${simbolo} ${c.seg_riesgo.toFixed(2)}</td>
            <td style="font-weight:bold; color:var(--primary-color)">${simbolo} ${c.totalFinal.toFixed(2)}</td>
        </tr>
      `;
  });

  // TOTALES SEPARADOS EN COLUMNAS
  tabla.innerHTML += `
    <tr style="background:#e2e8f0; font-weight:bold;">
        <td colspan="2" style="text-align:center;">TOTALES</td>
        <td>${simbolo} ${totalAmort.toFixed(2)}</td>
        <td>${simbolo} ${totalInteres.toFixed(2)}</td>
        <td>${simbolo} ${totalSegDesg.toFixed(2)}</td>
        <td>${simbolo} ${totalSegRiesgo.toFixed(2)}</td>
        <td style="color:var(--primary-color)">${simbolo} ${totalPagar.toFixed(2)}</td>
    </tr>
  `;

  // INDICADORES
  const tasaDesc = parseFloat(document.getElementById('tasaDescuento').value) || 15;
  const inversionNeta = parseFloat(document.getElementById('monto').value); 
  
  const { van } = calcularVAN(inversionNeta, flujosCaja, tasaDesc/100);
  const tirPer = calcularTIR(inversionNeta, flujosCaja);
  const tirAnual = Math.pow(1 + tirPer, 360/frecuenciaDias) - 1;
  const tcea = tirAnual; 

  document.getElementById('indicadoresContent').innerHTML = `
    <div class="kpi-item"><span class="kpi-label">VAN</span><span class="kpi-value" style="color:#166534">${simbolo} ${van.toFixed(2)}</span></div>
    <div class="kpi-item"><span class="kpi-label">TIR</span><span class="kpi-value" style="color:#0369a1">${(tirAnual*100).toFixed(2)}%</span></div>
    <div class="kpi-item"><span class="kpi-label">TCEA</span><span class="kpi-value" style="color:#b45309">${(tcea*100).toFixed(2)}%</span></div>
    <div class="kpi-item"><span class="kpi-label">Cuota Promedio</span><span class="kpi-value">${simbolo} ${(totalPagar/plazo).toFixed(2)}</span></div>
  `;

  // GUARDAR
  try {
      const payload = {
        clientId: parseInt(document.getElementById('clientSelect').value),
        propertyId: parseInt(document.getElementById('propertySelect').value),
        amount: inversionNeta,
        term_months: plazo,
        annual_rate: tasaInput,
        start_date: document.getElementById('fecha').value,
        bono_monto: parseFloat(document.getElementById('bonoMonto').value)||0,
        moneda: moneda,
        tasa_descuento: tasaDesc,
        van_calculado: van,
        tir_anual: tirAnual,
        tcea_anual: tcea,
        total_pagar: totalPagar,
        cuota_total: cronogramaFinal[0]?.totalFinal || 0,
        cronograma: cronogramaFinal.map(r => ({
            installment_number: r.installment_number,
            amortization: r.amortization,
            interest: r.interest,
            total: r.totalFinal,
            balance: r.balance
        }))
      };

      const res = await fetch(api+'/loans', {
        method:'POST',
        headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
        body: JSON.stringify(payload)
      });
      
      if(res.ok){
          const data = await res.json();
          ok.style.display='block';
          ok.innerText = "¡Plan guardado exitosamente! ID: " + data.loan.id;
      }
  } catch(err) { console.error(err); }
};
</script>
</body>
</html>